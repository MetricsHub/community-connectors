extends:
- ../System/System
connector:
  displayName: Linux - Processes (ps)
  platforms: Any platform with LinuxOS
  reliesOn: Linux OsCommands
  information: Gives process specific information and metrics
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - linux
    criteria:
    - type: commandLine
      commandLine: /usr/bin/which ps || /bin/which ps
      expectedResult: /usr/bin/ps
      errorMessage: Not a valid Linux host.
    tags: [ system, linux ]
monitors:
  process:
    simple:
      sources:
        process:
          type: commandLine
          commandLine: ps -eo user,pid,pcpu,pmem,etimes,command
          computes:
          - type: awk
            script: |
              {
                user = $1
                pid = $2
                cpu = $3
                mem = $4
                time = $5
                cpu_time = (cpu / 100) * time
                # Concatenate the full command from $6 to $NF
                command = ""
                for (i = 6; i <= NF; i++) {
                  command = command $i " "
                }
                 # Remove the trailing space
                command = substr(command, 1, length(command)-1)

                printf "%s;%s;%s;%s;%s;%s;%s\n", user, pid, cpu, mem, time, cpu_time, command
              }
          # Exclude the header row
          - type: excludeMatchingLines
            column: 1
            regExp: '^USER'
          # Filter by process command
          - type: keepOnlyMatchingLines
            column: 7
            regExp: '${var::processCommandRegex}'
          # Filter by process user
          - type: keepOnlyMatchingLines
            column: 1
            regExp: '${var::processUserRegex}'
      mapping:
        # pid;cpu;mem;time;cpu_time;command
        source: ${source::process}
        attributes:
          id: $7
          system.process.path: $7
        metrics:
          system.process.pid: $2
          system.process.cpu.utilization: $3
          system.process.memory.utilization: $4
          system.process.time: $5
          system.process.cpu.time: $6