extends:
- ../System/System
connector:
  displayName: Linux - Processes (ps)
  platforms: Any platform with LinuxOS
  reliesOn: Linux OsCommands
  information: Gives process specific information and metrics
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - linux
    criteria:
    - type: commandLine
      commandLine: /usr/bin/which ps || /bin/which ps
      expectedResult: /usr/bin/ps
      errorMessage: Not a valid Linux host.
    tags: [ system, linux ]
monitors:
  process:
    simple:
      sources:
        process:
          type: commandLine
          commandLine: /usr/bin/ps --no-headers -e -w -o pid,ppid,comm,user,pcpu,pmem,rss,vsz,thcount,etimes,command
          computes:
          - type: awk
            script: |
              {
                pid = $1
                ppid = $2
                comm = $3
                user = $4
                cpu = $5
                mem = $6
                rss = $7 * 1024
                vsz = $8 * 1024
                thcount= $9
                etimes = $10
                cputimes = (cpu / 100) * etimes
                # Concatenate the full command from $11 to $NF
                command = ""
                for (i = 11; i <= NF; i++) {
                  command = command $i " "
                }
                # Remove the trailing space
                command = substr(command, 1, length(command)-1)
                gsub(";", "", command)

                printf "%s;%s;%s;%s;%s;%s;%s;%s;%s;%s;%s;%s\n", pid,ppid,comm,user,cpu,cputimes,mem,rss,vsz,thcount,etimes,command
              }
          # Filter by process name
          - type: keepOnlyMatchingLines
            column: 3
            regExp: '${var::matchName}'
          # Filter by process command
          - type: keepOnlyMatchingLines
            column: 12
            regExp: '${var::matchCommand}'
          # Filter by process user
          - type: keepOnlyMatchingLines
            column: 4
            regExp: '${var::matchUser}'
      mapping:
        # pid;ppid;comm;user;pcpu;cputimes;pmem;rss;vsz;thcount;etimes;command
        source: ${source::process}
        attributes:
          id: $12
          process.id: $1
          process.parent.id: $2
          process.name: $3
          process.match.name: ${var::matchName}
          process.match.command: ${var::matchCommand}
          process.match.user: ${var::matchUser}
        metrics:
          process.cpu.utilization: $5
          process.cpu.time: $6
          process.memory.utilization: $7
          process.memory.usage: $8
          process.memory.virtual: $9
          process.thread.count: $10
          process.time: $11