extends:
- ../System/System
connector:
  displayName: Windows - Processes (WMI)
  platforms: Any Windows system
  reliesOn: WMI
  information: Monitors essential performance metrics of any Windows system through WMI, following OpenTelemetry semantic conventions.
  detection:
    appliesTo:
    - windows
    criteria:
    - type: wmi
      namespace: root\CIMv2
      query: SELECT Name FROM Win32_OperatingSystem
    tags: [ system, windows ]
monitors:
  process:
    simple:
      sources:
        processQuery:
          # 1 ProcessId;Name;ParentProcessId;ExecutablePath;ThreadCount;
          # 6 PageFaults;ReadOperationCount;ReadTransferCount;
          # 9 WriteOperationCount;WriteTransferCount;CommandLine;
          # 12 WorkingSetSize;VirtualSize;KernelModeTime;UserModeTime;HandleCount
          type: wmi
          namespace: root\CIMv2
          query: | 
            SELECT
            ProcessId,
            Name,
            ParentProcessId,
            ExecutablePath,
            ThreadCount,
            PageFaults,
            ReadOperationCount,
            ReadTransferCount,
            WriteOperationCount,
            WriteTransferCount,
            CommandLine,
            WorkingSetSize,
            VirtualSize,
            KernelModeTime,
            UserModeTime,
            HandleCount
            FROM Win32_Process
          computes:
          - type: keepOnlyMatchingLines
            column: 2
            regExp: ${var::matchName}
          - type: keepOnlyMatchingLines
            column: 11
            regExp: ${var::matchCommand}
          - type: add
            column: 14
            value: $15
          - type: divide
            column: 14 #  unit = 100-nanosecond intervals
            value: 10000000 # divide by 10000000 to get a result in seconds
      mapping:
        source: ${source::processQuery}
        attributes:
          id: $11 # The commandLine is the monitor id
          process.id: $1
          process.name: $2
          process.parent.id: $3
          process.match.name: ${var::matchName}
          process.match.command: ${var::matchCommand}
          process.path: $4
        metrics:
          process.thread.count: $5 # integer
          process.paging.faults: $6 # integer
          process.disk.operations{disk.io.direction="read"}: $7 # integer
          process.disk.operations{disk.io.direction="write"}: $9 # integer
          process.disk.io{disk.io.direction="read"}: $8 # bytes
          process.disk.io{disk.io.direction="write"}: $10 # bytes
          process.memory.usage: $12 # bytes
          process.memory.virtual: $13 # bytes
          process.cpu.time: $14 # seconds
          process.open_file_descriptor.count: $16 # integer