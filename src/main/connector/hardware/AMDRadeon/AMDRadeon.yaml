---
extends:
- ../../semconv/Hardware
connector:
  displayName: AMD Radeon (ROCm SMI)
  platforms: Any system with AMD Radeon GPUs
  reliesOn: ROCm drivers with rocm-smi support.
  information: This connector provides hardware information about AMD Radeon GPUs.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - Linux
    criteria:
    - type: commandLine
      commandLine: rocm-smi
      expectedResult: ROCm System Management Interface
      errorMessage: rocm-smi not found at target host.
    tags: [ hardware ]

monitors:
  enclosure:
    simple:
      sources:
        source(1):
        #id;cardModel;cardVendor;serialNumber;edgeTemp;junctionTemp;memTemp;gpuUse;gpuMemUse;avgPower;maxPower;voltage_mV;energyCnt;memBw;performanceLevelsc;lkClockSpeed
          type: commandLine
          commandLine: rocm-smi -a --csv
          timeout: 90
          computes:
          - type: awk
            script: ${file::rocmSmi.awk}
          - type : divide
            column: 14
            value: 1000000000
      mapping:
        source: ${source::source(1)}
  gpu:
    type: multiInstance
    simple:
      mapping:
        source: ${source::monitors.enclosure.simple.sources.source(1)}
        attributes:
          vendor: AMD
          id: $1
          model: $2
          serial_number: $4
          name: $1
          info: ${awk::join(" ", $2, $3)}
          # Performance policy of the GPU (auto, manual, low, high). Usually static and defined by administrator.
          performance_level: $15
          hw.parent.type: enclosure
        metrics:
            hw.gpu.utilization: percent2Ratio($8)
            hw.power{hw.type="gpu"}: $10
            hw.power.limit{hw.type="gpu"}: $11
            hw.energy{hw.type="gpu"}: $13 #energyCnt
            hw.gpu.speed: megaHertz2Hertz($16) #sclk speed
            hw.gpu.memory.utilization: percent2Ratio($9)
            hw.gpu.memory.bandwidth: $14 # memBw 
  temperature_edge:
    keys:
    - id
    - sensor_location
    type: multiInstance
    simple:
      mapping:
        source: ${source::monitors.enclosure.simple.sources.source(1)}
        attributes:
          id: $1
          hw.parent.type: enclosure
          sensor_location: gpu_edge
          name: ${awk::sprintf("%s (%s)", $1, "temperature_edge")}
        metrics:
          hw.temperature: $5 # edgeTemp
  temperature_junction:
    keys:
    - id
    - sensor_location
    type: multiInstance
    simple:
      mapping:
        source: ${source::monitors.enclosure.simple.sources.source(1)}
        attributes:
          id: $1
          hw.parent.type: enclosure
          sensor_location: gpu_junction
          name: ${awk::sprintf("%s (%s)", $1, "temperature_junction")}
        metrics:
          hw.temperature: $6 # junctionTemp
  temperature_memory:
    keys:
    - id
    - sensor_location
    type: multiInstance
    simple:
      mapping:
        source: ${source::monitors.enclosure.simple.sources.source(1)}
        attributes:
          id: $1
          hw.parent.type: enclosure
          sensor_location: gpu_memory
          name: ${awk::sprintf("%s (%s)", $1, "temperature_memory")}
        metrics:
          hw.temperature: $7 # memTemp
  voltage:
    type: multiInstance
    simple:
      mapping:
        source: ${source::monitors.enclosure.simple.sources.source(1)}
        attributes:
          id: $1
          hw.parent.type: enclosure
          sensor_location: gpu
          name: ${awk::sprintf("%s (%s)", $1, "voltage")}
        metrics:
          hw.voltage: milliVolt2Volt($12)
  fan:
    type: multiInstance
    simple:
      sources:
        source(1):
          type: commandLine
          commandLine: rocm-smi
          timeout: 90
          computes:
          - type: awk
            script: ${file::rocmSmiFan.awk}
      mapping:
        source: ${source::source(1)}
        attributes:
          id: $1
          sensor_location: gpu
          hw.parent.type: enclosure
          name: ${awk::sprintf("%s (%s)", $1, "fan")}
        metrics:
          hw.fan.speed_ratio: percent2Ratio($2)
