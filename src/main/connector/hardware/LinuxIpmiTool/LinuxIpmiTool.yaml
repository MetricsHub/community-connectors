---
extends:
- ../../semconv/Hardware
- ../../semconv/System
connector:
  displayName: Linux IPMI (ipmitool)
  platforms: IPMI
  reliesOn: IPMI
  information: This connector provides environmental information on several IPMI-enabled servers in-band and out-of-band (temperatures, fans, etc.).
  version: 2.0
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - Linux
    supersedes:
    - IpmiTool
    criteria:
    - type: commandline
      commandLine: PATH=$PATH:/usr/local/bin:/usr/sfw/bin;export PATH;ipmitool -I open bmc info
      expectedResult: IPMI Version
      errorMessage: Did not get the expected result from the IPMI tool command
    tags: [ hardware, linux ]

monitors:
  enclosure:
    simple:
      sources:
        allFrus:
          type: commandLine
          commandLine: PATH=$PATH:/usr/local/bin:/usr/sfw/bin;export PATH;ipmitool -I open fru
          computes:
          - type: awk
            script: ${file::frus_formatter.awk}
        sdr:
          type: commandLine
          commandLine: PATH=$PATH:/usr/local/bin:/usr/sfw/bin;export PATH;ipmitool -I open -v sdr elist all
          computes:
          - type: awk
            script: ${file::sdr_formatter.awk}
        fruUnionSdr:
          type: tableUnion
          tables:
            - ${source::allFrus}
            - ${source::sdr}
          computes:
          - type: awk
            script: ${file::translateIpmi.awk}
          - type: awk
            script: ${file::../IpmiTool/enclosure.awk}
            keep: ^MSHW;
            separators: ;
            selectColumns: 2,3,4,5,6,7,8,9,10,11
        enclosures:
          # enclosures = copy of fruUnionSdr
          type: copy
          from: ${source::fruUnionSdr}
          computes:
            # Keep only the enclosure line
            # Enclosure;Vendor;Model;SerialNumber;Status;StatusInformation;PowerConsumption;AdditionalInformation
          - type: keepOnlyMatchingLines
            column: 1
            valueList: enclosure
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Enclosure;Vendor;Model;SerialNumber;Status;StatusInformation;PowerConsumption
          - type: convert
            column: 5
            conversion: array2SimpleStatus
      mapping:
        # InstanceTable = enclosures
        source: ${source::enclosures}
        attributes:
          id: IPMI
          vendor: $2
          model: $3
          serial_number: $4
          info: $8
        conditionalCollection:
          hw.status{hw.type="enclosure"}: $5
          hw.enclosure.power: $7
        metrics:
          hw.status{hw.type="enclosure"}: $5
          hw.enclosure.power: $7
          hw.enclosure.energy: fakeCounter($7)
        legacyTextParameters:
          StatusInformation: $6

  fan:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        fans:
          # fans = copy of Enclosure.Simple.fruUnionSdr
          # SensorType;SensorID;SensorName;Location;FanSpeed;WarningThreshold;AlarmThreshold
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only fans
            # Fan;SensorID;SensorName;Location;FanSpeed;WarningThreshold;AlarmThreshold
          - type: keepOnlyMatchingLines
            column: 1
            valueList: fan
            # Add empty Status and StatusInformation columns
            # Fan;SensorID;SensorName;StatusArray;StatusInformation;Location;FanSpeed;WarningThreshold;AlarmThreshold;
          - type: append
            column: 3
            value: ;;
            # Add empty AdditionalInformation1 column at the very end
            # Fan;SensorID;SensorName;StatusArray;StatusInformation;Location;FanSpeed;WarningThreshold;AlarmThreshold;AdditionalInformation1;
          - type: append
            column: 9
            value: ;
      mapping:
        # The instance table
        source: ${source::fans}
        attributes:
          id: $2
          sensor_location: $6
          info: $10
          hw.parent.type: enclosure
          hw.parent.id: IPMI
        metrics:
          hw.status{hw.type="fan"}: $4
          hw.fan.speed: $7
          hw.fan.speed.limit{limit_type="low.degraded"}: $8
          hw.fan.speed.limit{limit_type="low.critical"}: $9
        conditionalCollection:
          hw.status{hw.type="fan"}: $4
          hw.fan.speed: $7
        legacyTextParameters:
          StatusInformation: $5

  temperature:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        temperatures:
          # temperature = copy of Enclosure.Simple.fruUnionSdr
          # SensorType;SensorID;SensorName;Location;Value;WarningThreshold;AlarmThreshold
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only fans
            # Temperature;SensorID;SensorName;Location;Value;WarningThreshold;AlarmThreshold
          - type: keepOnlyMatchingLines
            column: 1
            valueList: temperature
      mapping:
        # The instance table
        source: ${source::temperatures}
        attributes:
          id: $2
          sensor_location: $4
          hw.parent.type: enclosure
          hw.parent.id: IPMI
          name: ${awk::sprintf("%s (%s)", $3, $4)}
        metrics:
          hw.temperature: $5
          hw.temperature.limit{limit_type="high.degraded"}: $6
          hw.temperature.limit{limit_type="high.critical"}: $7

  voltage:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        voltages:
          # voltages = copy of Enclosure.Simple.fruUnionSdr
          # SensorType;SensorID;SensorName;Location;Value;WarningThreshold;AlarmThreshold
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only fans
            # Voltage;SensorID;SensorName;Location;Value;WarningThreshold;AlarmThreshold
          - type: keepOnlyMatchingLines
            column: 1
            valueList: voltage
      mapping:
        # The instance table
        source: ${source::voltages}
        attributes:
          id: $2
          sensor_location: $4
          hw.parent.type: enclosure
          hw.parent.id: IPMI
          name: ${awk::sprintf("%s (%s)", $3, $4)}
        metrics:
          hw.voltage: milliVolt2Volt($5)
          hw.voltage.limit{limit_type="low.critical"}: milliVolt2Volt($6)
          hw.voltage.limit{limit_type="high.critical"}: milliVolt2Volt($7)

  power_supply:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        powerSupplies:
          # powerSupplies = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only power supply lines
            # DeviceType;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: keepOnlyMatchingLines
            column: 4
            regExp: ^Power Supply
          - type: prepend
            column: 6
            value: "SerialNumber: "
          - type: prepend
            column: 5
            value: "Model: "
        powerSupplies2:
          # powerSupplies = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only power supply lines
            # DeviceType;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: keepOnlyMatchingLines
            column: 3
            regExp: ^Power Supply
        powerSuppliesJoin:
          type: tableJoin
          leftTable: ${source::powerSupplies}
          rightTable: ${source::powerSupplies2}
          leftKeyColumn: 4
          rightKeyColumn: 3
          computes:
          - type: append
            column: 12
            value: $13
          - type: convert
            column: 12
            conversion: array2SimpleStatus
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Power supply;DeviceID;Entity ID;Vendor;Model;SerialNumber;Status;StatusInformation

      mapping:
        # InstanceTable = powerSupplies
        source: ${source::powerSuppliesJoin}
        attributes:
          id: $2
          info: ${awk::join(" ", $9, $8)}
          hw.parent.type: enclosure
          hw.parent.id: IPMI
          name: $2
        metrics:
          hw.status{hw.type="power_supply"}: $12
        legacyTextParameters:
          StatusInformation: $8

  cpu:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        processors:
          # processors = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only processor lines
            # Processor;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1
          - type: keepOnlyMatchingLines
            column: 1
            valueList: Processor
          - type: prepend
            column: 6
            value: "SerialNumber: "
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Processor;DeviceID;Entity ID;Vendor;Model;SerialNumber;Status;StatusInformation
          - type: convert
            column: 7
            conversion: array2SimpleStatus
      mapping:
        # InstanceTable = processors
        source: ${source::processors}
        attributes:
          id: $2
          vendor: $4
          model: $5
          info: ${awk::join(" ", $9, $6)}
          hw.parent.type: enclosure
          hw.parent.id: IPMI
        metrics:
          hw.status{hw.type="cpu"}: $7
        legacyTextParameters:
          StatusInformation: $8

  memory:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        memories:
          # memories = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only memory lines
            # Memory module;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1
          - type: keepOnlyMatchingLines
            column: 1
            valueList: Memory module,Memory Device
            # Duplicate the "Model" column because it is in the form of Model|Speed
            # Memory module;DeviceID;Entity ID;Vendor;Model|Speed;Model|Speed;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: duplicateColumn
            column: 5
            # Now extract "Model" from "Model|Size"
            # Memory module;DeviceID;Entity ID;Vendor;Model;Model|Speed;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: extract
            column: 5
            subColumn: 1
            subSeparators: '|'
            # Now extract "Size" from "Model|Size"
            # Memory module;DeviceID;Entity ID;Vendor;Model;Speed;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: extract
            column: 6
            subColumn: 2
            subSeparators: '|'
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Memory module;DeviceID;Entity ID;Vendor;Model;SerialNumber;Status;StatusInformation
          - type: convert
            column: 8
            conversion: array2SimpleStatus
      mapping:
        # InstanceTable = memories
        source: ${source::memories}
        attributes:
          id: $2
          vendor: $4
          model: $5
          serial_number: $7
          info: $10
          hw.parent.type: enclosure
          hw.parent.id: IPMI
          name: ${awk::sprintf("%s (%s - %s MB)", $3, $4, $6)}
        metrics:
          hw.memory.limit: mebiByte2Byte($6)
          hw.status{hw.type="memory"}: $8
        legacyTextParameters:
          StatusInformation: $9

  physical_disk:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        physicalDisks:
          # physicalDisks = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only disk lines
            # Disk or disk bay;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: keepOnlyMatchingLines
            column: 1
            valueList: Disk or disk bay,Disk or Disk Bay,Disk Drive Bay
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Disk or disk bay;DeviceID;Entity ID;Vendor;Model;SerialNumber;Status;StatusInformation
          - type: convert
            column: 7
            conversion: array2SimpleStatus
      mapping:
        # InstanceTable = physicalDisks
        source: ${source::physicalDisks}
        attributes:
          id: $2
          vendor: $4
          model: $5
          serial_number: $6
          info: $9
          hw.parent.type: enclosure
          hw.parent.id: IPMI
        metrics:
          hw.status{hw.type="physical_disk"}: $7
        legacyTextParameters:
          StatusInformation: $8

  led:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        leds:
          # leds = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only LED lines
            # LED;DeviceID;Name;EntityID;Color;OnStatus;OffStatus;BlinkingStatus;Status;
          - type: keepOnlyMatchingLines
            column: 1
            valueList: led
      mapping:
        # InstanceTable = leds
        source: ${source::leds}
        attributes:
          id: $2
          color: $5
          __on_status: $6
          __off_status: $7
          __blinking_status: $8
          hw.parent.type: enclosure
          hw.parent.id: IPMI
          name: ${awk::sprintf("%s (%s)", $3, $5)}
        metrics:
          hw.status{hw.type="led"}: legacyLedStatus($9)
        legacyTextParameters:
          StatusInformation: $9

  other_device:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        otherDevices:
          # otherDevices = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Exclude what we know already
            # DeviceType;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: excludeMatchingLines
            column: 1
            valueList: Battery,Disk or Disk Bay,Disk or disk bay,Disk Drive Bay,Memory module,Memory Device,LED,Temperature,Voltage,Power supply,Fan,Fan Device,Enclosure,FRU,Processor,Current,PowerConsumption,EnergyUsage,Blade,Processing Blade
          - type: prepend
            column: 6
            value: "Serial Number: "
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Disk or disk bay;DeviceID;Entity ID;Vendor;Model;SerialNumber;Status;StatusInformation
          - type: convert
            column: 7
            conversion: array2SimpleStatus
      mapping:
        # InstanceTable = otherDevices
        source: ${source::otherDevices}
        attributes:
          device_type: $1
          id: $2
          additional_label: $4
          info: ${awk::join(" ", $9, $6)}
          hw.parent.type: enclosure
          hw.parent.id: IPMI
        metrics:
          hw.status{hw.type="other_device"}: $7
        legacyTextParameters:
          StatusInformation: $8

  blade:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        blades:
          # blades = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only blade lines
            # Blade;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: keepOnlyMatchingLines
            column: 1
            valueList: "Blade,Processing Blade"
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Blade;DeviceID;Entity ID;Vendor;Model;SerialNumber;Status;StatusInformation
          - type: convert
            column: 7
            conversion: array2SimpleStatus
      mapping:
        # InstanceTable = blades
        source: ${source::blades}
        attributes:
          id: $2
          model: $5
          serial_number: $6
          info: $9
          hw.parent.type: enclosure
          hw.parent.id: IPMI
          name: ${awk::sprintf("%s (%s)", $2, $5)}
        metrics:
          hw.status{hw.type="blade"}: $7
        legacyTextParameters:
          StatusInformation: $8

  battery:
    simple:
      # Collect type is: multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        batteries:
          # batteries = copy of Enclosure.Simple.fruUnionSdr
          type: copy
          from: ${source::monitors.enclosure.simple.sources.fruUnionSdr}
          computes:
            # Keep only battery lines
            # Battery;DeviceID;Entity ID;Vendor;Model;SerialNumber;StatusArray;StatusInformation;AdditionalInformation1;
          - type: keepOnlyMatchingLines
            column: 1
            valueList: battery
          - type: prepend
            column: 6
            value: "serialNumber: "
            # Convert StatusArray to a simple (unique) PATROLStatus
            # Battery;DeviceID;Entity ID;Vendor;Model;SerialNumber;Status;StatusInformation
          - type: convert
            column: 7
            conversion: array2SimpleStatus
      mapping:
        # InstanceTable = batteries
        source: ${source::batteries}
        attributes:
          id: $2
          model: $5
          info: ${awk::join(" ", $9, $6)}
          hw.parent.type: enclosure
          hw.parent.id: IPMI
        metrics:
          hw.status{hw.type="battery"}: $7
        legacyTextParameters:
          StatusInformation: $8